datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                Int      @id @default(autoincrement())
  email             String   @unique
  password          String
  verified          Boolean  @default(false)
  verificationToken String?  @unique
  createdAt         DateTime @default(now())

  resetToken    String?   @unique
  resetTokenExp DateTime?

  name     String?
  location String?
  bio      String?

  reputationScore Float @default(0)
  tradesClosed    Int   @default(0)

  active Boolean @default(true)

  role UserRole @default(OFERENTE)

  proposerTrades  Trade[] @relation("ProposerTrades")
  responderTrades Trade[] @relation("ResponderTrades")

  ofertas Oferta[]
}

enum UserRole {
  OFERENTE
  BUSCADOR
  ADMINISTRADOR
}

enum TradeStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum OfferStatus {
  BORRADOR
  PUBLICADA
  PAUSADA
}

model Trade {
  id          Int @id @default(autoincrement())
  proposerId  Int
  responderId Int

  proposerOfferJson  Json
  responderOfferJson Json

  proposerConfirmed  Boolean @default(false)
  responderConfirmed Boolean @default(false)

  status   TradeStatus @default(PENDING)
  closedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  proposer  User @relation("ProposerTrades", fields: [proposerId], references: [id])
  responder User @relation("ResponderTrades", fields: [responderId], references: [id])

  TradeClosure TradeClosure?

  @@index([proposerId])
  @@index([responderId])
}

model TradeClosure {
  id          Int         @id @default(autoincrement())
  tradeId     Int         @unique
  proposerId  Int
  responderId Int
  offerA      Json
  offerB      Json
  closedAt    DateTime
  finalStatus TradeStatus
  trade       Trade       @relation(fields: [tradeId], references: [id])
  createdAt   DateTime    @default(now())
}

model CategoriaOferta {
  id        Int      @id @default(autoincrement())
  nombre    String   @db.VarChar(100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  activo    Boolean  @default(true)

  ofertas Oferta[]

  @@map("categoria_oferta")
}

model Oferta {
  id                      Int            @id @default(autoincrement())
  titulo                  String         @db.VarChar(255)
  condicionTrueque        String         @db.VarChar(255)
  comentarioObligatorio   String         @db.VarChar(255)
  latitud                 Float
  longitud                Float
  
  userId                  Int
  user                    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  categoriaId             Int
  categoria               CategoriaOferta @relation(fields: [categoriaId], references: [id])
  
  status                  OfferStatus    @default(BORRADOR)
  
  imagenes                ImagenOferta[]
  
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  activo                  Boolean        @default(true)

  @@index([userId])
  @@index([categoriaId])
  @@index([status])
  @@unique([titulo, userId, activo])
  @@map("oferta")
}

model ImagenOferta {
  id            Int      @id @default(autoincrement())
  ofertaId      Int
  oferta        Oferta   @relation(fields: [ofertaId], references: [id], onDelete: Cascade)
  
  url           String   @db.VarChar(500)
  nombre        String?  @db.VarChar(255)
  tamanioBytes  Int
  orden         Int      @default(0)
  
  createdAt     DateTime @default(now())

  @@index([ofertaId])
  @@map("imagen_oferta")
}
