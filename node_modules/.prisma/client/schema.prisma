datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// MODELOS ----------------------------------------------------------

model User {
  id                Int      @id @default(autoincrement())
  email             String   @unique
  password          String
  verified          Boolean  @default(false)
  verificationToken String?  @unique
  createdAt         DateTime @default(now())

  // RecuperaciÃ³n de contraseÃ±a
  resetToken    String?   @unique
  resetTokenExp DateTime?

  // --- NUEVOS CAMPOS DE PERFIL ---
  name     String?
  location String?
  bio      String?

  // --- REPUTACIÃ“N ---
  reputationScore Float @default(0)
  tradesClosed    Int   @default(0)

  // --- ESTADO DE CUENTA ---
  active Boolean @default(true)

  // -- Relaciones con la tabla Trade --
  proposerTrades  Trade[] @relation("ProposerTrades")
  responderTrades Trade[] @relation("ResponderTrades")
}

// ENUMS

enum TradeStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

// MODELO DE TRUEQUES

model Trade {
  id          Int @id @default(autoincrement())
  proposerId  Int
  responderId Int

  proposerOfferJson  Json
  responderOfferJson Json

  proposerConfirmed  Boolean @default(false)
  responderConfirmed Boolean @default(false)

  status   TradeStatus @default(PENDING)
  closedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  proposer  User @relation("ProposerTrades", fields: [proposerId], references: [id])
  responder User @relation("ResponderTrades", fields: [responderId], references: [id])

  TradeClosure TradeClosure?

  @@index([proposerId])
  @@index([responderId])
}

// ðŸ‘‡ NUEVO modelo de registro de cierre
model TradeClosure {
  id          Int         @id @default(autoincrement())
  tradeId     Int         @unique
  proposerId  Int
  responderId Int
  offerA      Json
  offerB      Json
  closedAt    DateTime
  finalStatus TradeStatus // usamos el enum que ya tienes (PENDING/CONFIRMED/CANCELLED)
  trade       Trade       @relation(fields: [tradeId], references: [id])
  createdAt   DateTime    @default(now())
}
